var z=Object.defineProperty,H=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var E=(a,n,t)=>n in a?z(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,R=(a,n)=>{for(var t in n||(n={}))Q.call(n,t)&&E(a,t,n[t]);if(B)for(var t of B(n))V.call(n,t)&&E(a,t,n[t]);return a},Y=(a,n)=>H(a,$(n));import{r as I,j as e,n as U,a as G,h as J}from"./index-8c8MWHS7.js";import{d as v,f as M}from"./helper-CqzKcjxO.js";import{a as K,u as X}from"./index.esm-SC33979T.js";import{a as w}from"./index-Cnws3vrW.js";import{u as P}from"./useNotify-DxgKAG4V.js";import{A as Z,R as ee,a as te}from"./AntCustomTable-PHLShk74.js";import{B as ae}from"./index-zognkRmJ.js";import{A as se}from"./AntDrawer-Bd2Srrkw.js";import{R as S}from"./RenderController-B-V75prw.js";import{A as k}from"./AntSelect-b23sTvdE.js";import{A as O}from"./AntDatePicker-DLUIi2jr.js";import{A as T}from"./AntInput-B1JBAOxi.js";import{a as ne,b as re,c as oe,d as ie}from"./dropdownApi-A7O2ZLcx.js";import{g as le}from"./customer-CrGr1P4O.js";import{u as q}from"./useDebounceSearch-EYe_KJ74.js";import{g as me,a as de}from"./SalesInvoice-Ctik4qad.js";import{C as ce,B as ue,S as pe}from"./doctype-strings-C-G4L_vj.js";import"./index-ClJ7qbIB.js";import{C as xe}from"./app-strings-Cs6FvmwH.js";import{R as W}from"./ClearOutlined-CTASUb55.js";import{R as he}from"./SendOutlined-KA_4C2Lc.js";import"./roundedArrow-EzlWGpmr.js";import"./useMergedState-HTTS6kwS.js";import"./index-FaQCZFv_.js";import"./bundle-mjs-Bbh6cNEC.js";import"./dropdown-C3hu2XBM.js";import"./LeftOutlined-pLHQlSZZ.js";import"./iconBase-BHFxWNPg.js";import"./pagination.utils-Dq4giu9F.js";const fe=({control:a,setValue:n})=>{const[t]=K({control:a,name:["customer_name"]}),[p,h]=I.useState(void 0),[f,C]=I.useState(null),{data:_,isLoading:D}=ne(),{mutate:j}=le(t),{mutate:d}=me({party_type:ce,party:t!=null?t:""}),{setSearchInput:N,data:{data:g,isLoading:b,mutate:i}}=q({fetchFunction:re}),{setSearchInput:c,data:{data:l,isLoading:o}}=q({fetchFunction:oe});return I.useEffect(()=>{t&&(j().then(s=>{var x;h(s),n("customer_details",s),C((x=s==null?void 0:s.customer_primary_address)!=null?x:null)}).finally(()=>{d().then(s=>{var u,y;const r=((y=(u=p==null?void 0:p.credit_limits)==null?void 0:u.reduce((L,m)=>L+(m.credit_limit||0),0))!=null?y:0)-((s==null?void 0:s.message)||0);n("remaining_balance",r)})}),i())},[t,j,i,n,p,d]),e.jsxs("div",{className:"mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 w-full bg-white dark:bg-darkmode-800 p-5 rounded-md drop-shadow-md intro-y",children:[S(a,"posting_date",e.jsx(O,{placeholder:"Select Posting Date",minDate:v()})),S(a,"customer_name",e.jsx(k,{placeholder:"Select Customer",options:g==null?void 0:g.map(s=>({value:s.name,label:s.customer_name})),loading:b,notFoundText:"No Customer Found",onSearch:s=>N(s),onClear:()=>N(null)})),S(a,"due_date",e.jsx(O,{placeholder:"Select Due Date"})),S(a,"warehouse_name",e.jsx(k,{placeholder:"Select Warehouse",options:_==null?void 0:_.map(s=>({value:s.name,label:s.warehouse_name})),loading:D,notFoundText:"No Warehouse Found"})),S(a,"territory_name",e.jsx(k,{placeholder:"Select Territory",options:l==null?void 0:l.map(s=>({value:s.name,label:s.territory_name})),loading:o,notFoundText:"No Territory Found",onSearch:s=>c(s),onClear:()=>c(null)})),S(a,"customer_address",e.jsx(k,{placeholder:"Select Address",options:f?[{value:f,label:f}]:[],notFoundText:"No Address Found",disabled:!t})),S(a,"remarks",e.jsx(T,{type:"text",placeholder:"Enter Remarks"}))]})},_e=(a,n)=>U("frappe.client.get_value",{doctype:ue,fieldname:"actual_qty",filters:{item_code:a,warehouse:n}},void 0,{isPaused:()=>!a||!n}),ge=({tableData:a,setTableData:n,watch:t})=>{const p=P(),{warehouse_name:h}=t(),[f,C]=I.useState(null),[_,D]=I.useState(""),{setSearchInput:j,data:{data:d,isLoading:N}}=q({fetchFunction:ie}),{mutate:g}=_e(_,h!=null?h:""),b=(i,c,l)=>{n(a.map((o,s)=>{if(s!==c)return o;const x=Y(R({},o),{[i]:l}),r=Number(x.quantity)||0,u=Number(x.rate)||0;return x.total=r*u,x}))};return I.useEffect(()=>{_&&f!==null&&h&&g().then(i=>{n(a.map((c,l)=>{var o;return l!==f?c:Y(R({},c),{available_stock:((o=i==null?void 0:i.message)==null?void 0:o.actual_qty)||"0"})}))})},[_,h,f,g]),[{title:"Item",dataIndex:"item_name",key:"item_name",render:(i,c,l)=>e.jsx(k,{placeholder:"Select Item",options:d==null?void 0:d.map(o=>({value:o.name,label:o.item_name})),loading:N,size:"middle",notFoundText:"No Item Found",onSearch:o=>j(o),onClear:()=>j(null),onChange:o=>{if(!h){p.error({message:"Error",description:"Please select warehouse first"});return}b("item_name",l,o),D(o),C(l)}})},{title:"Available Stock",dataIndex:"available_stock",key:"available_stock",render(i){return e.jsx("span",{className:`${i==="Select Item Name"?"text-red-500 font-semibold":""}`,children:i||""})}},{title:"Quantity",dataIndex:"quantity",key:"quantity",render:(i,c,l)=>e.jsx(T,{type:"number",placeholder:"Enter Quantity",size:"middle",onChange:o=>{b("quantity",l,o.target.value)}})},{title:"Rate",dataIndex:"rate",key:"rate",render:(i,c,l)=>e.jsx(T,{type:"number",placeholder:"Enter Rate",size:"middle",onChange:o=>b("rate",l,o.target.value)})},{title:"Total",dataIndex:"total",key:"total",render:i=>e.jsx("div",{children:i||"0"})}]},Ge=()=>{var x;const a=P(),n=G(),[t,p]=I.useState([]),{control:h,reset:f,watch:C,handleSubmit:_,setValue:D}=X({mode:"onChange",resetOptions:{keepDirtyValues:!0},defaultValues:{posting_date:v(),customer_details:void 0,remaining_balance:0}}),{customer_name:j,customer_details:d,remaining_balance:N}=C(),{createDoc:g,loading:b}=de(),i=()=>{f(),p([])},c=r=>{var y,L;const u={creation:v().format("YYYY-MM-DD HH:mm:ss"),modified:v().format("YYYY-MM-DD HH:mm:ss"),docstatus:1,customer:r.customer_name,customer_name:r.customer_name,company:xe,company_address:(y=r.customer_details)==null?void 0:y.customer_primary_address,posting_date:v(r.posting_date).format("YYYY-MM-DD"),set_posting_time:1,due_date:v(r.due_date).format("YYYY-MM-DD"),territory:r.territory_name,total_qty:t.reduce((m,F)=>{var A;return m+((A=F.quantity)!=null?A:0)},0),update_stock:0,total:t.reduce((m,F)=>{var A;return m+((A=F.total)!=null?A:0)},0),items:t.map(m=>({name:m.item_name,item_name:m.item_name,item_code:m.item_name,qty:m.quantity,rate:m.rate,amount:m.total})),remarks:r.remarks,sales_team:(L=r.customer_details)==null?void 0:L.sales_team};g(pe,u).then(()=>{a.success({message:"Sales Invoice Submitted Successfully"}),i()}).catch(m=>{a.error({message:m.message,description:m.exception})})},l=()=>{const r={item_name:"",available_stock:"Select Item Name",quantity:0,rate:0,total:0};p([...t,r])},o=r=>{p(t.filter(u=>u!==r))},s=ge({tableData:t,setTableData:p,watch:C});return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mt-5",children:[e.jsx("h2",{className:"text-2xl text-primary font-bold",children:"Details"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"text-lg text-primary font-semibold",children:["Remaining Balance : ",N]}),e.jsx(w,{label:"Limit Details",icon:e.jsx(W,{}),color:"cyan",variant:"solid",disabled:!j,onClick:()=>{n(J({type:"limit-details",isOpen:!0}))}}),e.jsx(w,{label:"Clear",icon:e.jsx(W,{}),color:"red",variant:"solid",onClick:i}),e.jsx(w,{label:"Submit",icon:e.jsx(he,{}),type:"primary",onClick:_(c),loading:b})]})]}),e.jsx(fe,{control:h,setValue:D}),e.jsx(Z,{className:"mt-5 drop-shadow-md intro-y",columns:[...s||[],{title:"Action",dataIndex:"action",key:"action",render:(r,u)=>e.jsx(ae,{onClick:()=>o(u),variant:"outline-danger",size:"sm",children:e.jsx(te,{})})}],data:t,loading:!1,title:()=>e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-between items-center px-2",children:[e.jsx("div",{className:"text-lg font-bold",children:"Items"}),e.jsx(w,{label:"Add Item",icon:e.jsx(ee,{}),onClick:l})]})}),footer:()=>e.jsxs("div",{className:"flex justify-end items-center",children:[e.jsx("div",{className:"text-lg font-bold",children:"Total : "}),e.jsx("div",{className:"text-lg font-bold ml-2",children:t.reduce((r,u)=>{var y;return r+((y=u.total)!=null?y:0)},0)})]}),scroll:{y:400},pagination:!1}),e.jsx(se,{title:"Brand Wise Credit Limit",children:e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto rounded-lg border",children:e.jsxs("table",{className:"min-w-full table-auto",children:[e.jsx("thead",{className:"bg-primary text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:"Brand Name"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Limit Amount"})]})}),e.jsxs("tbody",{className:"bg-gray-50",children:[(x=d==null?void 0:d.custom_brand_wise_allocations)==null?void 0:x.map(r=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-left",children:r.brand}),e.jsx("td",{className:"px-6 py-4 text-left",children:M(r.limit)})]},r.name)),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-left",children:"Others"}),e.jsx("td",{className:"px-6 py-4 text-left",children:M((d==null?void 0:d.custom_other_brands_limit)||0)})]})]})]})})})})]})};export{Ge as default};

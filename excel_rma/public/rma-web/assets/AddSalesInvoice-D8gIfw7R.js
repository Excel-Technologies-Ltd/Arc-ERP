var z=Object.defineProperty,H=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var B=(a,s,t)=>s in a?z(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t,F=(a,s)=>{for(var t in s||(s={}))$.call(s,t)&&B(a,t,s[t]);if(q)for(var t of q(s))Q.call(s,t)&&B(a,t,s[t]);return a},R=(a,s)=>H(a,V(s));import{r as _,j as e,n as U,a as G,h as J}from"./index-QPILswrD.js";import{d as v}from"./dayjs.min-Bju8Bm85.js";import{u as K,a as X}from"./index.esm-Gb2rxiL2.js";import{A as w}from"./AntdIcon-Dzaldfw9.js";import{u as P}from"./useNotify-De7ujSeO.js";import{A as Z,R as ee,a as te}from"./AntCustomTable-C451gdWY.js";import{B as ae}from"./index-CUSu5boT.js";import{A as se}from"./AntDrawer-B1fSTFO5.js";import{R as I}from"./RenderController-BWckelOB.js";import{A as k}from"./AntSelect-Yp46YRqw.js";import{A as M}from"./AntDatePicker-C6GSPkKC.js";import{A as Y}from"./AntInput-gFpR4Gq9.js";import{a as ne,b as re,c as oe,d as ie}from"./dropdownApi-DKZ7QRtX.js";import{g as le}from"./customer-D9mFEO_y.js";import{g as me,a as de}from"./SalesInvoice-RbcmQ14_.js";import{C as ce,B as ue,S as pe}from"./doctype-strings-C-G4L_vj.js";import"./index-nM6YCXA5.js";import"./AntRangePicker-D3KpdtM5.js";import"./index-BkZZ9SdE.js";import{f as O}from"./helper-BZfnQWdd.js";import{C as he}from"./app-strings-Cs6FvmwH.js";import{R as W}from"./ClearOutlined-LPNMDtJ1.js";import{R as xe}from"./SendOutlined-DJZIG94-.js";import"./roundedArrow-CDIRV2Qv.js";import"./useMergedState-Bwr_xbyQ.js";import"./index-B9jbv-p4.js";import"./dropdown-CYrLyETq.js";import"./LeftOutlined-BoaGrQm-.js";import"./bundle-mjs-Bbh6cNEC.js";import"./iconBase-DIxS6YTF.js";import"./pagination.utils-Dq4giu9F.js";const fe=(a,s=500)=>{const[t,m]=_.useState(a);return _.useEffect(()=>{const c=setTimeout(()=>{m(a)},s);return()=>{clearTimeout(c)}},[a,s]),t},E=({fetchFunction:a,debounceDelay:s=0})=>{const[t,m]=_.useState(null),c=fe(t,s),x=a(c);return{searchInput:t,setSearchInput:m,data:x}},_e=({control:a,setValue:s})=>{const[t]=K({control:a,name:["customer_name"]}),[m,c]=_.useState(void 0),[x,C]=_.useState(null),{data:g,isLoading:D}=ne(),{mutate:j}=le(t),{mutate:u}=me({party_type:ce,party:t!=null?t:""}),{setSearchInput:N,data:{data:y,isLoading:S,mutate:i}}=E({fetchFunction:re}),{setSearchInput:p,data:{data:l,isLoading:o}}=E({fetchFunction:oe});return _.useEffect(()=>{t&&(j().then(n=>{var f;c(n),s("customer_details",n),C((f=n==null?void 0:n.customer_primary_address)!=null?f:null)}).finally(()=>{u().then(n=>{var h,b;const r=((b=(h=m==null?void 0:m.credit_limits)==null?void 0:h.reduce((L,d)=>L+(d.credit_limit||0),0))!=null?b:0)-((n==null?void 0:n.message)||0);s("remaining_balance",r)})}),i())},[t,j,i,s,m,u]),e.jsxs("div",{className:"mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 w-full bg-white dark:bg-darkmode-800 p-5 rounded-md drop-shadow-md intro-y",children:[I(a,"posting_date",e.jsx(M,{placeholder:"Select Posting Date",minDate:v()})),I(a,"customer_name",e.jsx(k,{placeholder:"Select Customer",options:y==null?void 0:y.map(n=>({value:n.name,label:n.customer_name})),loading:S,notFoundText:"No Customer Found",onSearch:n=>N(n),onClear:()=>N(null)})),I(a,"due_date",e.jsx(M,{placeholder:"Select Due Date"})),I(a,"warehouse_name",e.jsx(k,{placeholder:"Select Warehouse",options:g==null?void 0:g.map(n=>({value:n.name,label:n.warehouse_name})),loading:D,notFoundText:"No Warehouse Found"})),I(a,"territory_name",e.jsx(k,{placeholder:"Select Territory",options:l==null?void 0:l.map(n=>({value:n.name,label:n.territory_name})),loading:o,notFoundText:"No Territory Found",onSearch:n=>p(n),onClear:()=>p(null)})),I(a,"customer_address",e.jsx(k,{placeholder:"Select Address",options:x?[{value:x,label:x}]:[],notFoundText:"No Address Found",disabled:!t})),I(a,"remarks",e.jsx(Y,{type:"text",placeholder:"Enter Remarks"}))]})},ge=(a,s)=>U("frappe.client.get_value",{doctype:ue,fieldname:"actual_qty",filters:{item_code:a,warehouse:s}},void 0,{isPaused:()=>!a||!s}),ye=({tableData:a,setTableData:s,watch:t})=>{const m=P(),{warehouse_name:c}=t(),[x,C]=_.useState(null),[g,D]=_.useState(""),{setSearchInput:j,data:{data:u,isLoading:N}}=E({fetchFunction:ie}),{mutate:y}=ge(g,c!=null?c:""),S=(i,p,l)=>{s(a.map((o,n)=>{if(n!==p)return o;const f=R(F({},o),{[i]:l}),r=Number(f.quantity)||0,h=Number(f.rate)||0;return f.total=r*h,f}))};return _.useEffect(()=>{g&&x!==null&&c&&y().then(i=>{s(a.map((p,l)=>{var o;return l!==x?p:R(F({},p),{available_stock:((o=i==null?void 0:i.message)==null?void 0:o.actual_qty)||"0"})}))})},[g,c,x,y]),[{title:"Item",dataIndex:"item_name",key:"item_name",render:(i,p,l)=>e.jsx(k,{placeholder:"Select Item",options:u==null?void 0:u.map(o=>({value:o.name,label:o.item_name})),loading:N,size:"middle",notFoundText:"No Item Found",onSearch:o=>j(o),onClear:()=>j(null),onChange:o=>{if(!c){m.error({message:"Error",description:"Please select warehouse first"});return}S("item_name",l,o),D(o),C(l)}})},{title:"Available Stock",dataIndex:"available_stock",key:"available_stock",render(i){return e.jsx("span",{className:`${i==="Select Item Name"?"text-red-500 font-semibold":""}`,children:i||""})}},{title:"Quantity",dataIndex:"quantity",key:"quantity",render:(i,p,l)=>e.jsx(Y,{type:"number",placeholder:"Enter Quantity",size:"middle",onChange:o=>{S("quantity",l,o.target.value)}})},{title:"Rate",dataIndex:"rate",key:"rate",render:(i,p,l)=>e.jsx(Y,{type:"number",placeholder:"Enter Rate",size:"middle",onChange:o=>S("rate",l,o.target.value)})},{title:"Total",dataIndex:"total",key:"total",render:i=>e.jsx("div",{children:i||"0"})}]},Xe=()=>{var f;const a=P(),s=G(),[t,m]=_.useState([]),{control:c,reset:x,watch:C,handleSubmit:g,setValue:D}=X({mode:"onChange",resetOptions:{keepDirtyValues:!0},defaultValues:{posting_date:v(),customer_details:void 0,remaining_balance:0}}),{customer_name:j,customer_details:u,remaining_balance:N}=C(),{createDoc:y,loading:S}=de(),i=()=>{x(),m([])},p=r=>{var b,L;const h={creation:v().format("YYYY-MM-DD HH:mm:ss"),modified:v().format("YYYY-MM-DD HH:mm:ss"),docstatus:1,customer:r.customer_name,customer_name:r.customer_name,company:he,company_address:(b=r.customer_details)==null?void 0:b.customer_primary_address,posting_date:v(r.posting_date).format("YYYY-MM-DD"),set_posting_time:1,due_date:v(r.due_date).format("YYYY-MM-DD"),territory:r.territory_name,total_qty:t.reduce((d,T)=>{var A;return d+((A=T.quantity)!=null?A:0)},0),update_stock:0,total:t.reduce((d,T)=>{var A;return d+((A=T.total)!=null?A:0)},0),items:t.map(d=>({name:d.item_name,item_name:d.item_name,item_code:d.item_name,qty:d.quantity,rate:d.rate,amount:d.total})),remarks:r.remarks,sales_team:(L=r.customer_details)==null?void 0:L.sales_team};y(pe,h).then(()=>{a.success({message:"Sales Invoice Submitted Successfully"}),i()}).catch(d=>{a.error({message:d.message,description:d.exception})})},l=()=>{const r={item_name:"",available_stock:"Select Item Name",quantity:0,rate:0,total:0};m([...t,r])},o=r=>{m(t.filter(h=>h!==r))},n=ye({tableData:t,setTableData:m,watch:C});return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mt-5",children:[e.jsx("h2",{className:"text-2xl text-primary font-bold",children:"Details"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"text-lg text-primary font-semibold",children:["Remaining Balance : ",N]}),e.jsx(w,{label:"Limit Details",icon:e.jsx(W,{}),color:"cyan",variant:"solid",disabled:!j,onClick:()=>{s(J({type:"limit-details",isOpen:!0}))}}),e.jsx(w,{label:"Clear",icon:e.jsx(W,{}),color:"red",variant:"solid",onClick:i}),e.jsx(w,{label:"Submit",icon:e.jsx(xe,{}),type:"primary",onClick:g(p),loading:S})]})]}),e.jsx(_e,{control:c,setValue:D}),e.jsx(Z,{className:"mt-5 drop-shadow-md intro-y",columns:[...n||[],{title:"Action",dataIndex:"action",key:"action",render:(r,h)=>e.jsx(ae,{onClick:()=>o(h),variant:"outline-danger",size:"sm",children:e.jsx(te,{})})}],data:t,loading:!1,title:()=>e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-between items-center px-2",children:[e.jsx("div",{className:"text-lg font-bold",children:"Items"}),e.jsx(w,{label:"Add Item",icon:e.jsx(ee,{}),onClick:l})]})}),footer:()=>e.jsxs("div",{className:"flex justify-end items-center",children:[e.jsx("div",{className:"text-lg font-bold",children:"Total : "}),e.jsx("div",{className:"text-lg font-bold ml-2",children:t.reduce((r,h)=>{var b;return r+((b=h.total)!=null?b:0)},0)})]}),scroll:{y:400},pagination:!1}),e.jsx(se,{title:"Brand Wise Credit Limit",children:e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto rounded-lg border",children:e.jsxs("table",{className:"min-w-full table-auto",children:[e.jsx("thead",{className:"bg-primary text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:"Brand Name"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Limit Amount"})]})}),e.jsxs("tbody",{className:"bg-gray-50",children:[(f=u==null?void 0:u.custom_brand_wise_allocations)==null?void 0:f.map(r=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-left",children:r.brand}),e.jsx("td",{className:"px-6 py-4 text-left",children:O(r.limit)})]},r.name)),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-left",children:"Others"}),e.jsx("td",{className:"px-6 py-4 text-left",children:O((u==null?void 0:u.custom_other_brands_limit)||0)})]})]})]})})})})]})};export{Xe as default};

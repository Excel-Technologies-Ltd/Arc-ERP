var z=Object.defineProperty,H=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var E=(a,r,t)=>r in a?z(a,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[r]=t,R=(a,r)=>{for(var t in r||(r={}))Q.call(r,t)&&E(a,t,r[t]);if(B)for(var t of B(r))V.call(r,t)&&E(a,t,r[t]);return a},Y=(a,r)=>H(a,$(r));import{r as I,j as e,n as U,a as G,h as J}from"./index-Bs2fFoTq.js";import{d as v,f as M}from"./helper-C7fgEP--.js";import{a as K,u as X}from"./index.esm-Bo6iHtQf.js";import{a as w}from"./index-BfK2uoct.js";import{u as P}from"./useNotify-D4k5WhO2.js";import{A as Z,R as ee,a as te}from"./AntCustomTable-D1pMEnd8.js";import{B as ae}from"./index-BJMyXKcI.js";import{A as se}from"./AntDrawer-DEBUAyZM.js";import{R as S}from"./RenderController-DPdF5Qev.js";import{A as k}from"./AntSelect-BF2LFWnv.js";import{A as O}from"./AntDatePicker-nhAZ6elL.js";import{A as T}from"./AntInput-Bup3bFrv.js";import{a as re,b as ne,c as oe,d as ie}from"./dropdownApi-CiZMrNdI.js";import{g as le}from"./customer-LNQc74vj.js";import{u as q}from"./useDebounceSearch-BTgNNY4N.js";import{g as me,a as de}from"./SalesInvoice-D3aoW086.js";import{C as ce,B as ue,S as pe}from"./doctype-strings-C-G4L_vj.js";import"./index-CLIG7Q7R.js";import{C as xe}from"./app-strings-BvIq5npe.js";import{R as W}from"./ClearOutlined-B1jBns8X.js";import{R as he}from"./SendOutlined-CLXDfpQE.js";import"./roundedArrow-BpmIDLu6.js";import"./useMergedState-BWzM43rH.js";import"./index-UFKEkCqV.js";import"./bundle-mjs-Bbh6cNEC.js";import"./dropdown-UvdrxGN2.js";import"./LeftOutlined-4cHtBPKe.js";import"./index-DmeS3EO7.js";import"./iconBase-CHnXMNis.js";import"./pagination.utils-Dq4giu9F.js";import"./index-D0x3kUiQ.js";const fe=({control:a,setValue:r})=>{const[t]=K({control:a,name:["customer_name"]}),[p,h]=I.useState(void 0),[f,C]=I.useState(null),{data:_,isLoading:D}=re(),{mutate:j}=le(t),{mutate:d}=me({party_type:ce,party:t!=null?t:""}),{setSearchInput:N,data:{data:g,isLoading:b,mutate:i}}=q({fetchFunction:ne}),{setSearchInput:c,data:{data:l,isLoading:o}}=q({fetchFunction:oe});return I.useEffect(()=>{t&&(j().then(s=>{var x;h(s),r("customer_details",s),C((x=s==null?void 0:s.customer_primary_address)!=null?x:null)}).finally(()=>{d().then(s=>{var u,y;const n=((y=(u=p==null?void 0:p.credit_limits)==null?void 0:u.reduce((L,m)=>L+(m.credit_limit||0),0))!=null?y:0)-((s==null?void 0:s.message)||0);r("remaining_balance",n)})}),i())},[t,j,i,r,p,d]),e.jsxs("div",{className:"mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 w-full bg-white dark:bg-darkmode-800 p-5 rounded-md drop-shadow-md intro-y",children:[S(a,"posting_date",e.jsx(O,{placeholder:"Select Posting Date",minDate:v()})),S(a,"customer_name",e.jsx(k,{placeholder:"Select Customer",options:g==null?void 0:g.map(s=>({value:s.name,label:s.customer_name})),loading:b,notFoundText:"No Customer Found",onSearch:s=>N(s),onClear:()=>N(null)})),S(a,"due_date",e.jsx(O,{placeholder:"Select Due Date"})),S(a,"warehouse_name",e.jsx(k,{placeholder:"Select Warehouse",options:_==null?void 0:_.map(s=>({value:s.name,label:s.warehouse_name})),loading:D,notFoundText:"No Warehouse Found"})),S(a,"territory_name",e.jsx(k,{placeholder:"Select Territory",options:l==null?void 0:l.map(s=>({value:s.name,label:s.territory_name})),loading:o,notFoundText:"No Territory Found",onSearch:s=>c(s),onClear:()=>c(null)})),S(a,"customer_address",e.jsx(k,{placeholder:"Select Address",options:f?[{value:f,label:f}]:[],notFoundText:"No Address Found",disabled:!t})),S(a,"remarks",e.jsx(T,{type:"text",placeholder:"Enter Remarks"}))]})},_e=(a,r)=>U("frappe.client.get_value",{doctype:ue,fieldname:"actual_qty",filters:{item_code:a,warehouse:r}},void 0,{isPaused:()=>!a||!r}),ge=({tableData:a,setTableData:r,watch:t})=>{const p=P(),{warehouse_name:h}=t(),[f,C]=I.useState(null),[_,D]=I.useState(""),{setSearchInput:j,data:{data:d,isLoading:N}}=q({fetchFunction:ie}),{mutate:g}=_e(_,h!=null?h:""),b=(i,c,l)=>{r(a.map((o,s)=>{if(s!==c)return o;const x=Y(R({},o),{[i]:l}),n=Number(x.quantity)||0,u=Number(x.rate)||0;return x.total=n*u,x}))};return I.useEffect(()=>{_&&f!==null&&h&&g().then(i=>{r(a.map((c,l)=>{var o;return l!==f?c:Y(R({},c),{available_stock:((o=i==null?void 0:i.message)==null?void 0:o.actual_qty)||"0"})}))})},[_,h,f,g]),[{title:"Item",dataIndex:"item_name",key:"item_name",render:(i,c,l)=>e.jsx(k,{placeholder:"Select Item",options:d==null?void 0:d.map(o=>({value:o.name,label:o.item_name})),loading:N,size:"middle",notFoundText:"No Item Found",onSearch:o=>j(o),onClear:()=>j(null),onChange:o=>{if(!h){p.error({message:"Error",description:"Please select warehouse first"});return}b("item_name",l,o),D(o),C(l)}})},{title:"Available Stock",dataIndex:"available_stock",key:"available_stock",render(i){return e.jsx("span",{className:`${i==="Select Item Name"?"text-red-500 font-semibold":""}`,children:i||""})}},{title:"Quantity",dataIndex:"quantity",key:"quantity",render:(i,c,l)=>e.jsx(T,{type:"number",placeholder:"Enter Quantity",size:"middle",onChange:o=>{b("quantity",l,o.target.value)}})},{title:"Rate",dataIndex:"rate",key:"rate",render:(i,c,l)=>e.jsx(T,{type:"number",placeholder:"Enter Rate",size:"middle",onChange:o=>b("rate",l,o.target.value)})},{title:"Total",dataIndex:"total",key:"total",render:i=>e.jsx("div",{children:i||"0"})}]},Ke=()=>{var x;const a=P(),r=G(),[t,p]=I.useState([]),{control:h,reset:f,watch:C,handleSubmit:_,setValue:D}=X({mode:"onChange",resetOptions:{keepDirtyValues:!0},defaultValues:{posting_date:v(),customer_details:void 0,remaining_balance:0}}),{customer_name:j,customer_details:d,remaining_balance:N}=C(),{createDoc:g,loading:b}=de(),i=()=>{f(),p([])},c=n=>{var y,L;const u={creation:v().format("YYYY-MM-DD HH:mm:ss"),modified:v().format("YYYY-MM-DD HH:mm:ss"),docstatus:1,customer:n.customer_name,customer_name:n.customer_name,company:xe,company_address:(y=n.customer_details)==null?void 0:y.customer_primary_address,posting_date:v(n.posting_date).format("YYYY-MM-DD"),set_posting_time:1,due_date:v(n.due_date).format("YYYY-MM-DD"),territory:n.territory_name,total_qty:t.reduce((m,F)=>{var A;return m+((A=F.quantity)!=null?A:0)},0),update_stock:0,total:t.reduce((m,F)=>{var A;return m+((A=F.total)!=null?A:0)},0),items:t.map(m=>({name:m.item_name,item_name:m.item_name,item_code:m.item_name,qty:m.quantity,rate:m.rate,amount:m.total})),remarks:n.remarks,sales_team:(L=n.customer_details)==null?void 0:L.sales_team};g(pe,u).then(()=>{a.success({message:"Sales Invoice Submitted Successfully"}),i()}).catch(m=>{a.error({message:m.message,description:m.exception})})},l=()=>{const n={item_name:"",available_stock:"Select Item Name",quantity:0,rate:0,total:0};p([...t,n])},o=n=>{p(t.filter(u=>u!==n))},s=ge({tableData:t,setTableData:p,watch:C});return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mt-5",children:[e.jsx("h2",{className:"text-2xl text-primary font-bold",children:"Details"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"text-lg text-primary font-semibold",children:["Remaining Balance : ",N]}),e.jsx(w,{label:"Limit Details",icon:e.jsx(W,{}),color:"cyan",variant:"solid",disabled:!j,onClick:()=>{r(J({type:"limit-details",isOpen:!0}))}}),e.jsx(w,{label:"Clear",icon:e.jsx(W,{}),color:"red",variant:"solid",onClick:i}),e.jsx(w,{label:"Submit",icon:e.jsx(he,{}),type:"primary",onClick:_(c),loading:b})]})]}),e.jsx(fe,{control:h,setValue:D}),e.jsx(Z,{className:"mt-5 drop-shadow-md intro-y",columns:[...s||[],{title:"Action",dataIndex:"action",key:"action",render:(n,u)=>e.jsx(ae,{onClick:()=>o(u),variant:"outline-danger",size:"sm",children:e.jsx(te,{})})}],data:t,loading:!1,title:()=>e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-between items-center px-2",children:[e.jsx("div",{className:"text-lg font-bold",children:"Items"}),e.jsx(w,{label:"Add Item",icon:e.jsx(ee,{}),onClick:l})]})}),footer:()=>e.jsxs("div",{className:"flex justify-end items-center",children:[e.jsx("div",{className:"text-lg font-bold",children:"Total : "}),e.jsx("div",{className:"text-lg font-bold ml-2",children:t.reduce((n,u)=>{var y;return n+((y=u.total)!=null?y:0)},0)})]}),scroll:{y:400},pagination:!1}),e.jsx(se,{title:"Brand Wise Credit Limit",children:e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto rounded-lg border",children:e.jsxs("table",{className:"min-w-full table-auto",children:[e.jsx("thead",{className:"bg-primary text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:"Brand Name"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Limit Amount"})]})}),e.jsxs("tbody",{className:"bg-gray-50",children:[(x=d==null?void 0:d.custom_brand_wise_allocations)==null?void 0:x.map(n=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-left",children:n.brand}),e.jsx("td",{className:"px-6 py-4 text-left",children:M(n.limit)})]},n.name)),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-left",children:"Others"}),e.jsx("td",{className:"px-6 py-4 text-left",children:M((d==null?void 0:d.custom_other_brands_limit)||0)})]})]})]})})})})]})};export{Ke as default};
